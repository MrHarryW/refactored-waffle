<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Refactored Waffle ðŸ§‡</title>
  <script src="https://cdn.jsdelivr.net/gh/cfinke/Typo.js@master/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/diff-match-patch@0.0.2/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 1200px; margin: 2rem auto; padding: 1rem; background: #f8f9fa; color: #212529; }
    @media (prefers-color-scheme: dark) { body { background: #121212; color: #e0e0e0; } }
    h1 { text-align: center; }
    .drop-zone { 
      border: 4px dashed #adb5bd; 
      border-radius: 1rem; 
      padding: 4rem; 
      text-align: center; 
      cursor: pointer; 
      transition: 0.3s; 
      background: #e9ecef; 
    }
    .drop-zone.dragover { border-color: #0d6efd; background: #cfe2ff; }
    @media (prefers-color-scheme: dark) { 
      .drop-zone { background: #343a40; } 
      .drop-zone.dragover { background: #0d47a1; } 
    }
    .upload-btn {
      background: #0d6efd; 
      color: white; 
      border: none; 
      padding: 1rem 2rem; 
      font-size: 1.2rem; 
      border-radius: 0.5rem; 
      cursor: pointer; 
      margin-top: 1rem;
    }
    .upload-btn:hover { background: #0b5ed7; }
    .results { margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .pane { border: 1px solid #dee2e6; padding: 1rem; height: 70vh; overflow: auto; background: white; border-radius: 0.5rem; }
    @media (prefers-color-scheme: dark) { .pane { background: #1e1e1e; border-color: #444; } }
    .diff ins { background: #d1e7dd; text-decoration: none; }
    .diff del { background: #f8d7da; text-decoration: line-through; }
    button.download { background: #0d6efd; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; margin-top: 1rem; }
    button.download:hover { background: #0b5ed7; }
    #progress { text-align: center; margin: 1rem 0; font-style: italic; }
  </style>
</head>
<body>
  <h1>ðŸ§‡ Refactored Waffle</h1>
  <p style="text-align:center;">Upload TXT, MD, or DOCX files. Fixes British English spelling, punctuation spacing, capitalization, and more. 100% private â€“ everything runs in your browser!</p>
  
  <div class="drop-zone" id="dropZone">
    <p>ðŸ“‚ Drag & drop files here<br><strong>or</strong></p>
    <label class="upload-btn" id="uploadBtn" for="fileInput" role="button" tabindex="0">Choose Files</label>
    <!-- Keep the input in the DOM but visually off-screen so programmatic clicks open the file picker in all browsers -->
    <input type="file" id="fileInput" multiple accept=".txt,.md,.docx" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;overflow:hidden;" aria-label="Choose text, markdown or docx files" tabindex="-1">
  </div>
  
  <div id="progress" style="display:none;">Processing your files...</div>
  <div id="error" style="color:#c00; text-align:center; display:none;"></div>
  
  <div class="results" id="results" style="display:none;">
    <div class="pane"><h3>Original</h3><pre id="original"></pre></div>
    <div class="pane"><h3>Refactored ðŸ§‡</h3><pre id="refactored"></pre>
      <button class="download" id="downloadBtn">ðŸ’¾ Download All Cleaned (ZIP)</button>
    </div>
  </div>

  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const progress = document.getElementById('progress');
    const results = document.getElementById('results');
    const errorBox = document.getElementById('error');
    let originalText = '', refactoredText = '';
    let cleanedFiles = [];

    // Load spellchecker â€“ attempt to fetch dictionaries; fall back to no-op spellchecker if missing
    let typo = null;
    (async function initTypo() {
      try {
        if (typeof Typo !== 'function') throw new Error('Typo library not loaded');
        const affResp = await fetch('dictionaries/en_GB/en_GB.aff');
        const dicResp = await fetch('dictionaries/en_GB/en_GB.dic');
        if (!affResp.ok || !dicResp.ok) throw new Error('Dictionary files not found');
        const aff = await affResp.text();
        const dic = await dicResp.text();
        typo = new Typo('en_GB', aff, dic, { platform: 'browser' });
        console.info('Typo dictionary loaded');
      } catch (err) {
        console.warn('Typo initialization failed; spellchecking disabled.', err);
        typo = { check: () => true, suggest: () => [] };
      }
    })();

    const dmp = new diff_match_patch();

    // The label is tied to the input via `for`; add keyboard activation for accessibility
    uploadBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        fileInput.click();
      }
    });

    // Click anywhere else in drop zone â†’ also open file explorer
    dropZone.addEventListener('click', () => fileInput.click());

    // Drag & drop visual feedback
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => {
      dropZone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); });
    });
    dropZone.addEventListener('dragenter', () => dropZone.classList.add('dragover'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => {
      dropZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    // File input change (from button or click)
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    // Rest of the script remains the same...
    async function handleFiles(files) {
      try {
        if (files.length === 0) return;
        progress.style.display = 'block';
        if (errorBox) errorBox.style.display = 'none';
        results.style.display = 'none';
        cleanedFiles = [];

        const file = files[0];
        const text = await extractText(file);
        originalText = text;
        refactoredText = refactorText(text);
        cleanedFiles.push({ name: file.name.replace(/\.[^/.]+$/, '_refactored.txt'), content: refactoredText });

        for (let i = 1; i < files.length; i++) {
          const t = await extractText(files[i]);
          const r = refactorText(t);
          cleanedFiles.push({ name: files[i].name.replace(/\.[^/.]+$/, '_refactored.txt'), content: r });
        }

        showDiff(originalText, refactoredText);
        progress.style.display = 'none';
        results.style.display = 'grid';
      } catch (err) {
        console.error(err);
        if (errorBox) {
          errorBox.textContent = 'Processing error: ' + (err && err.message ? err.message : String(err));
          errorBox.style.display = 'block';
        }
        progress.style.display = 'none';
      }
    }

    async function extractText(file) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = async e => {
          if (file.name.endsWith('.docx')) {
            const result = await mammoth.convertToHtml({ arrayBuffer: e.target.result });
            resolve(result.value.replace(/<[^>]*>/g, '').trim());
          } else if (file.name.endsWith('.pdf')) {
            // PDFs aren't supported by the in-browser text extractor in this demo
            resolve('[PDF files are not supported in this demo]');
          } else {
            // Try to decode as UTF-8 text
            try {
              resolve(new TextDecoder().decode(new Uint8Array(e.target.result)));
            } catch (err) {
              resolve('');
            }
          }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    function refactorText(text) {
      let fixed = text
        .replace(/([.!?])\s{2,}/g, '$1 ')
        .replace(/\s+/g, ' ')
        .replace(/^\s+|\s+$/g, '')
        .replace(/(^|[.!?]\s+)([a-z])/g, (m, p, l) => p + l.toUpperCase());

      const words = fixed.match(/\b\w+\b/g) || [];
      words.forEach(word => {
        const lower = word.toLowerCase();
        try {
          if (typo && typeof typo.check === 'function' && !typo.check(lower)) {
            const suggestions = typeof typo.suggest === 'function' ? typo.suggest(lower) : [];
            if (suggestions.length > 0) {
              const suggestion = suggestions[0];
              const capitalized = suggestion.charAt(0).toUpperCase() + suggestion.slice(1);
              fixed = fixed.replace(new RegExp('\\b' + word + '\\b', 'gi'),
                word[0] === word[0].toUpperCase() ? capitalized : suggestion);
            }
          }
        } catch (e) {
          // Ignore spellchecker errors and continue
          console.warn('Spellcheck error for word', word, e);
        }
      });

      return fixed;
    }

    function showDiff(orig, ref) {
      const diff = dmp.diff_main(orig, ref);
      dmp.diff_cleanupSemantic(diff);
      const html = diff.map(part => {
        if (part[0] === 0) return `<span>${part[1].replace(/\n/g, '<br>')}</span>`;
        if (part[0] === 1) return `<ins>${part[1].replace(/\n/g, '<br>')}</ins>`;
        if (part[0] === -1) return `<del>${part[1].replace(/\n/g, '<br>')}</del>`;
      }).join('');
      document.getElementById('original').textContent = orig;
      document.getElementById('refactored').innerHTML = html;
    }

    window.addEventListener('error', e => {
      console.error(e.error || e.message || e);
      if (errorBox) {
        errorBox.textContent = 'An unexpected error occurred: ' + (e.message || e.error || '');
        errorBox.style.display = 'block';
      }
      progress.style.display = 'none';
    });

    document.getElementById('downloadBtn').onclick = () => {
      const zip = new JSZip();
      cleanedFiles.forEach(f => zip.file(f.name, f.content));
      zip.generateAsync({ type: 'blob' }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'refactored_waffle_files.zip';
        a.click(); URL.revokeObjectURL(url);
      });
    };
  </script>
</body>
</html>